## Содержание

1. [Требования и предварительные настройки](#1-требования-и-предварительные-настройки)
2. [Настройка маршрутизатора MikroTik RouterOS](#2-настройка-маршрутизатора-mikrotik-routeros)
   - [2.1. Настройка перенаправления портов (Port Forwarding)](#21-настройка-перенаправления-портов-port-forwarding)
   - [2.2. Настройка правил файрвола](#22-настройка-правил-файрвола)
3. [Развертывание контейнеров Vaultwarden и Caddy](#3-развертывание-контейнеров-vaultwarden-и-caddy)
   - [3.1. Подготовка постоянного хранилища (Persistent Storage)](#31-подготовка-постоянного-хранилища-persistent-storage)
   - [3.2. Развертывание Vaultwarden](#32-развертывание-vaultwarden)
   - [3.3. Развертывание Caddy](#33-развертывание-caddy)
4. [Настройка Caddy для обратного проксирования и SSL](#4-настройка-caddy-для-обратного-проксирования-и-ssl)
   - [4.1. Конфигурационный файл Caddy](#41-конфигурационный-файл-caddy)
5. [Тестирование и проверка настроек](#5-тестирование-и-проверка-настроек)
   - [5.1. Проверка SSL-сертификата](#51-проверка-ssl-сертификата)
   - [5.2. Проверка доступности сервисов](#52-проверка-доступности-сервисов)
   - [5.3. Устранение распространённых проблем](#53-устранение-распространённых-проблем)
6. [Лучшие практики безопасности](#6-лучшие-практики-безопасности)
   - [6.1. Строгая политика паролей для Vaultwarden](#61-строгая-политика-паролей-для-vaultwarden)
   - [6.2. Защита маршрутизатора и контейнерной среды](#62-защита-маршрутизатора-и-контейнерной-среды)
7. [Заключение](#7-заключение)

---

## 1. Требования и предварительные настройки

Перед началом убедитесь, что у вас есть:

- **Маршрутизатор MikroTik RouterOS** с публичным IP-адресом `Ваш белый IP-адрес`.
- **Два локальных сервера** с IP-адресами:
  - Vaultwarden: `192.168.2.20`
  - Caddy: `192.168.2.21`
- **Доменное имя** `pass.vault.ru`, указывающее на публичный IP `Ваш белый IP-адрес`.
- **Доступ к RouterOS** через WinBox или SSH с административными правами.
- **Установленные пакеты Container** на RouterOS для работы с контейнерами.
- **Достаточно ресурсов** (CPU, память, дисковое пространство) на RouterOS для запуска контейнеров.

---

## 2. Настройка маршрутизатора MikroTik RouterOS

### 2.1. Настройка перенаправления портов (Port Forwarding)

Для обеспечения доступа к веб-сервисам из интернета необходимо перенаправить порты HTTP (80) и HTTPS (443) на сервер Caddy (`192.168.2.21`).

**Шаги:**

1. **Подключитесь к RouterOS** через WinBox или SSH.

2. **Добавьте правила перенаправления портов:**

   Выполните следующие команды в терминале RouterOS:

   ```shell
   # Перенаправление порта 80 (HTTP) на Caddy
   /ip firewall nat add chain=dstnat dst-address=185.160.217.246 protocol=tcp dst-port=80 action=dst-nat to-addresses=192.168.2.21 to-ports=80 comment="Port Forward HTTP to Caddy"

   # Перенаправление порта 443 (HTTPS) на Caddy
   /ip firewall nat add chain=dstnat dst-address=185.160.217.246 protocol=tcp dst-port=443 action=dst-nat to-addresses=192.168.2.21 to-ports=443 comment="Port Forward HTTPS to Caddy"
   ```

   **Пояснения:**

   - `dst-address`: публичный IP вашего маршрутизатора.
   - `to-addresses`: локальный IP сервера Caddy.
   - `dst-port`: исходный порт (80 или 443).
   - `to-ports`: порт на локальном сервере (обычно совпадает).

3. **Проверьте добавленные правила:**

   ```shell
   /ip firewall nat print
   ```

   Убедитесь, что правила успешно добавлены и активны.

### 2.2. Настройка правил файрвола

Для обеспечения безопасности необходимо ограничить доступ к внутренним сервисам и разрешить только необходимые порты.

**Шаги:**

1. **Разрешите необходимые входящие соединения:**

   ```shell
   /ip firewall filter add chain=input protocol=tcp dst-port=80,443,8291 action=accept comment="Allow HTTP, HTTPS and WinBox"

   # Разрешите уже установленные соединения
   /ip firewall filter add chain=input connection-state=established,related action=accept comment="Allow established and related"

   # Запретите остальное
   /ip firewall filter add chain=input action=drop comment="Drop all other inbound traffic"
   ```

   **Пояснения:**

   - `dst-port=80,443`: разрешаем доступ к HTTP и HTTPS.
   - `dst-port=8291`: стандартный порт для WinBox (измените, если используете другой).
   - `connection-state=established,related`: разрешаем уже установленные соединения.
   - Остальное запрещаем для повышения безопасности.

2. **Сохраните настройки:**

   Все внесенные изменения автоматически сохраняются в RouterOS, но рекомендуется сделать резервную копию:

   ```shell
   /system backup save name=router-backup
   ```

3. **Проверьте работу файрвола:**

   Убедитесь, что доступ к портам 80 и 443 из интернета возможен, а остальные порты защищены.

---

## 3. Развертывание контейнеров Vaultwarden и Caddy

Для развертывания контейнеров на RouterOS используется встроенный функционал контейнеризации. Рассмотрим процесс развертывания для обоих сервисов.

### 3.1. Подготовка постоянного хранилища (Persistent Storage)

Для сохранения данных между перезагрузками контейнеров необходимо настроить постоянное хранилище.

**Шаги:**

1. **Создайте директории для хранения данных:**

   Используя SSH или файловый менеджер RouterOS, создайте папки на файловой системе:

   - Для Vaultwarden: `/disk1/vaultwarden/data`
   - Для Caddy: `/disk1/caddy/data`

   ```shell
   /file print
   /file mkdir disk1/vaultwarden
   /file mkdir disk1/vaultwarden/data
   /file mkdir disk1/caddy
   /file mkdir disk1/caddy/data
   ```

   **Примечание:** Убедитесь, что диск `disk1` доступен и имеет достаточное место.

2. **Назначьте права доступа (если необходимо):**

   RouterOS не предоставляет сложных систем прав, но убедитесь, что директории доступны для контейнеров.

### 3.2. Развертывание Vaultwarden

Vaultwarden — это легковесная альтернатива Bitwarden, написанная на Rust.

**Шаги:**

1. **Загрузите Docker-образ Vaultwarden:**

   ```shell
   /container image pull vaultwarden/server:latest
   ```

2. **Создайте контейнер Vaultwarden:**

   ```shell
   /сontainer add remote-image=vaultwarden/server:latest interface=container_bridge root-dir=disk1/vaultwarden envlist=vaultwarden_envs
   ```

   **Пояснения:**

   - `remote-image`: используемый образ.
   - `interface`: на каком интерфейсе будет развернут контейиер.
   - `envlist`: список с переменными окружения.
   - `root-dir`: директория доступа.

3. **Запустите контейнер:**

   ```shell
   /container start vaultwarden
   ```

4. **Проверьте статус контейнера:**

   ```shell
   /container print
   ```

### 3.3. Развертывание Caddy

Caddy — это современный веб-сервер с автоматическим управлением SSL-сертификатами.

**Шаги:**

1. **Загрузите Docker-образ Caddy:**

   ```shell
   /container image pull caddy:latest
   ```

2. **Создайте конфигурационный файл Caddy:**

   Перед созданием контейнера создадим конфигурационный файл `Caddyfile`.

   **Создание Caddyfile:**

   Используйте встроенный редактор файлов RouterOS или загрузите файл через FTP/SFTP.

   Пример содержимого `Caddyfile`:

   ```caddyfile
   pass.vault.ru {
       reverse_proxy 192.168.2.20:8080
       log {
           output file /data/caddy/access.log
           level INFO
       }
       tls {
           on_demand
       }
   }
   ```

   **Пояснения:**

   - `pass.vault.ru`: домен для доступа.
   - `reverse_proxy`: перенаправление трафика на Vaultwarden.
   - `log`: настройка логирования.
   - `tls`: автоматическое получение SSL-сертификата через Let's Encrypt.

   **Сохраните файл как `/disk1/caddy/Caddyfile`.**

3. **Создайте контейнер Caddy:**

   ```shell
   /container add name=caddy \
     image=caddy:latest \
     ports=80:80,443:443 \
     volumes=disk1/caddy/Caddyfile:/etc/caddy/Caddyfile \
     volumes=disk1/caddy/data:/data \
     restart-policy=always
   ```

   **Пояснения:**

   - `ports`: маппинг портов 80 и 443 на контейнерные порты 80 и 443.
   - `volumes`: монтирование конфигурационного файла и постоянного хранилища.
   - `restart-policy=always`: автоматический перезапуск контейнера при сбоях.

4. **Запустите контейнер:**

   ```shell
   /container start caddy
   ```

5. **Проверьте статус контейнера:**

   ```shell
   /container print
   ```

---

## 4. Настройка Caddy для обратного проксирования и SSL

Caddy автоматически управляет SSL-сертификатами через Let's Encrypt. Однако для корректной работы необходимо убедиться в правильности конфигурации.

### 4.1. Конфигурационный файл Caddy

**Пример `Caddyfile`:**

```caddyfile
pass.vault.ru {
    reverse_proxy 192.168.2.20:8080

    log {
        output file /data/caddy/access.log
        level INFO
    }

    tls youremail@example.com
}
```

**Пояснения:**

- `reverse_proxy`: перенаправляет запросы на Vaultwarden.
- `log`: настраивает логирование.
- `tls`: указывает email для регистрации в Let's Encrypt (замените `youremail@example.com` на ваш реальный email).

**Шаги по обновлению Caddyfile:**

1. **Редактируйте Caddyfile:**

   Если вы еще не настроили `Caddyfile`, убедитесь, что он содержит правильную конфигурацию.

   ```shell
   /file edit disk1/caddy/Caddyfile
   ```

   Вставьте содержимое, как показано выше, и сохраните изменения.

2. **Перезапустите контейнер Caddy для применения изменений:**

   ```shell
   /container restart caddy
   ```

3. **Проверьте логи Caddy для диагностики:**

   ```shell
   /container log caddy
   ```

   Убедитесь, что Caddy успешно запустился и получил SSL-сертификат.

---

## 5. Тестирование и проверка настроек

После развертывания и настройки сервисов необходимо проверить их работоспособность и корректность SSL-сертификатов.

### 5.1. Проверка SSL-сертификата

1. **Откройте браузер и перейдите по адресу:**

   ```
   https://pass.vault.ru
   ```

2. **Проверьте, что соединение защищено:**

   - Убедитесь, что в адресной строке отображается замок.
   - Нажмите на замок, чтобы просмотреть детали сертификата (например, что он выдан Let's Encrypt).

3. **Используйте онлайн-инструменты:**

   - [SSL Labs](https://www.ssllabs.com/ssltest/) — введите `pass.vault.ru` для детального анализа SSL-конфигурации.

### 5.2. Проверка доступности сервисов

1. **Проверьте доступ к Vaultwarden через Caddy:**

   - В браузере перейдите по адресу `https://pass.vault.ru`.
   - Убедитесь, что открывается интерфейс Vaultwarden.

2. **Проверьте локальный доступ:**

   - Внутри сети перейдите по адресу `http://192.168.2.21` (Caddy) и `http://192.168.2.20:8080` (Vaultwarden), чтобы убедиться, что сервисы работают локально.

### 5.3. Устранение распространённых проблем

**Проблема 1: Caddy не может получить SSL-сертификат**

- **Возможные причины:**
  - Неправильные настройки DNS (домены не указывают на публичный IP).
  - Порты 80 и 443 не перенаправлены на Caddy.
  - Файрвол блокирует доступ.

- **Решения:**
  - Проверьте запись DNS для `pass.vault.ru`.
  - Убедитесь, что правила NAT настроены правильно.
  - Проверьте файрвол на RouterOS.

**Проблема 2: Ошибка маршрутизации**

- **Возможные причины:**
  - Неправильный IP-адрес в настройках прокси.
  - Контейнеры не запущены или работают некорректно.

- **Решения:**
  - Проверьте IP-адреса и порты в `Caddyfile`.
  - Убедитесь, что контейнеры Vaultwarden и Caddy запущены.

**Проблема 3: Контейнеры не запускаются**

- **Возможные причины:**
  - Недостаточно ресурсов (памяти, CPU).
  - Ошибки в конфигурационных файлах.

- **Решения:**
  - Проверьте доступные ресурсы на RouterOS.
  - Просмотрите логи контейнеров:

    ```shell
    /container log vaultwarden
    /container log caddy
    ```

---

## 6. Лучшие практики безопасности

Обеспечение безопасности — критически важный аспект при настройке веб-сервисов и сетевой инфраструктуры.

### 6.1. Строгая политика паролей для Vaultwarden

1. **Настройте требования к паролям:**

   Vaultwarden поддерживает различные политики паролей. Рекомендуется использовать сложные пароли с длиной не менее 12 символов, включающими буквы, цифры и специальные символы.

2. **Используйте `ADMIN_TOKEN`:**

   - Убедитесь, что `ADMIN_TOKEN` установлен и хранится в секрете.
   - Это позволяет администраторам управлять Vaultwarden.

3. **Ограничьте доступ к административным функциям:**

   - Не размещайте `ADMIN_TOKEN` в публичных местах.
   - Используйте защищенные каналы для административного доступа.

### 6.2. Защита маршрутизатора и контейнерной среды

1. **Обновляйте RouterOS и контейнеры:**

   - Регулярно проверяйте обновления RouterOS и устанавливайте их.
   - Обновляйте образы контейнеров до последних версий для устранения уязвимостей.

2. **Ограничьте доступ к RouterOS:**

   - Используйте сложные пароли для административных учетных записей.
   - Ограничьте доступ к административным интерфейсам (WinBox, SSH) только с доверенных IP-адресов, если возможно.

   ```shell
   /ip service set winbox address=192.168.2.0/24
   /ip service set ssh address=192.168.2.0/24
   ```

3. **Используйте сети VLAN и сегментацию:**

   - Разделите сеть на сегменты для различных сервисов, ограничив доступ между ними.

4. **Мониторинг и логирование:**

   - Включите логирование на RouterOS для отслеживания подозрительной активности.
   - Регулярно просматривайте логи контейнеров и маршрутизатора.

5. **Используйте брандмауэр внутри контейнеров (если поддерживается):**

   - Настройте дополнительные правила файрвола внутри контейнеров для ограничения доступа.

---

## 7. Заключение

Вы успешно настроили защищенный доступ к сервису Vaultwarden через Caddy на MikroTik RouterOS с использованием бесплатного SSL-сертификата от Let's Encrypt. Следуя данной инструкции, вы обеспечили безопасную и надежную среду для управления паролями.

**Рекомендуется:**

- Регулярно проверять обновления для RouterOS и контейнерных образов.
- Периодически пересматривать и обновлять политики безопасности.
- Создавать резервные копии конфигураций и данных Vaultwarden.

Если возникнут дополнительные вопросы или проблемы, обратитесь к официальной документации MikroTik, Caddy и Vaultwarden или свяжитесь с профессиональными специалистами по сетевой безопасности.

---

**Успехов в вашей работе!**
